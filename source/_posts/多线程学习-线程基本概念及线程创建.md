---
title: 多线程学习-线程基本概念及线程创建
id: 176
categories:
  - 系统编程
date: 2008-07-16 23:19:00
tags:
---

    <SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体><FONT face="Times New Roman">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>以前上操作系统时学过一些关于进程，线程以及同步的理论，也在Linux做过一些多线程的实验，但是感觉那些都只是为了应付课程之类的东东，今天看了孙鑫老师的VC视频第15讲，主要讲的线程的创建以及使用互斥对象进行线程同步操作，感觉他这套视频确实是很经典。下面总结一下学习的东西：</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>程序是计算机指令的集合，它以文件的形式存储在磁盘上。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>进程</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>：通常被定义为一个正在运行的程序的实例，是一个程序在其自身的地址空间中的一次执行活动。进程是资源申请、调度和独立运行的单位，因此，它使用系统中的运行资源；而程序不能申请系统资源，不能被系统调度，也不能作为独立运行的单位，因此，它不占用系统的运行资源。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>进程由两个部分组成</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>：</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">1<FONT face=宋体>、操作系统用来管理进程的内核对象。内核对象也是系统用来存放关于进程的统计信息的地方。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">2<FONT face=宋体>、地址空间。它包含所有可执行模块或DLL模块的代码和数据。它还包含动态内存分配的空间。如线程堆栈和堆分配空间。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>进程是不活泼的。进程从来不执行任何东西，它只是线程的容器。若要使进程完成某项操作，它必须拥有一个在它的环境中运行的线程，此线程负责执行包含在进程的地址空间中的代码。单个进程可能包含若干个线程，这些线程都“同时” 执行进程地址空间中的代码。每个进程至少拥有一个线程，来执行进程的地址空间中的代码。当创建一个进程时，操作系统会自动创建这个进程的第一个线程，称为主线程。此后，该线程可以创建其他的线程。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>线程由两个部分组成</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>：</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">1<FONT face=宋体>、线程的内核对象，操作系统用它来对线程实施管理。内核对象也是系统用来存放线程统计信息的地方。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">2<FONT face=宋体>、线程堆栈，它用于维护线程在执行代码时需要的所有参数和局部变量。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>当创建线程时，系统创建一个线程内核对象。该线程内核对象不是线程本身，而是操作系统用来管理线程的较小的数据结构。可以将线程内核对象视为由关于线程的统计信息组成的一个小型数据结构。 </FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>线程总是在某个进程环境中创建。系统从进程的地址空间中分配内存，供线程的堆栈使用。新线程运行的进程环境与创建线程的环境相同。因此，新线程可以访问进程的内核对象的所有句柄、进程中的所有内存和在这个相同的进程中的所有其他线程的堆栈。这使得单个进程中的多个线程确实能够非常容易地互相通信。 </FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>线程只有一个内核对象和一个堆栈，保留的记录很少，因此所需要的内存也很少。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>因为线程需要的开销比进程少，因此在编程中经常采用多线程来解决编程问题，而尽量避免创建新的进程。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>操作系统为每一个运行线程安排一定的CPU时间 —— 时间片。系统通过一种循环的方式为线程提供时间片，线程在自己的时间内运行，因时间片相当短，因此，给用户的感觉，就好像线程是同时运行的一样。如果计算机拥有多个CPU，线程就能真正意义上同时运行了。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>创建线程主要使用API函数CreateThread，在MSDN中的原型声明为：</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">HANDLE</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">CreateThread(</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">&nbsp;&nbsp;</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">LPSECURITY_ATTRIBUTES</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-SIZE: 10.5pt; FONT-STYLE: italic; mso-spacerun: yes">lpThreadAttributes</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">, </SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">&nbsp;&nbsp;</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">SIZE_T</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-SIZE: 10.5pt; FONT-STYLE: italic; mso-spacerun: yes">dwStackSize</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">, </SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">&nbsp;&nbsp;</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">LPTHREAD_START_ROUTINE</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-SIZE: 10.5pt; FONT-STYLE: italic; mso-spacerun: yes">lpStartAddress</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">, </SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">&nbsp;&nbsp;</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">LPVOID</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-SIZE: 10.5pt; FONT-STYLE: italic; mso-spacerun: yes">lpParameter</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">, </SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">&nbsp;&nbsp;</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">DWORD</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-SIZE: 10.5pt; FONT-STYLE: italic; mso-spacerun: yes">dwCreationFlags</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">, </SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">&nbsp;&nbsp;</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">LPDWORD</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-SIZE: 10.5pt; FONT-STYLE: italic; mso-spacerun: yes">lpThreadId</SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-WEIGHT: bold; FONT-SIZE: 10.5pt; mso-spacerun: yes">);</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"> </SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>第一个参数为线程安全属性，一般设置为NULL就可以了；第二个参数是线程使用的堆栈大小，设为0就可以了，表示使用默认的；第三个参数即是线程的起始地址，也就是线程函数；第四个参数是传递给线程函数的参数，一般都会经过case的；第五个参数是线程创建标志，若为CREATE_SUSPENDED表示线程创建后被挂起，需要通过ResumeThread唤醒之，一般设为0表示马上执行；最后一个参数是一个传出参数，表示线程ID。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>可以通过ExitThread来显示终止线程，注意这个函数需要传递线程ID，所以在创建线程时就要记录线程ID，通过CloseHandle可以递减分配给线程的所有内核对象计数。</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>下面通过视频中的火车站售票系统来说明如何使用CreateThread创建线程，这个例子确实很实用：</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体></FONT></SPAN>&nbsp;
<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"><FONT face=宋体>
<DIV class=highlighter>

</DIV>

代码很简单，需要注意的就是</FONT></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">**CloseHandle并没有终止该线程，只是使该线程的内核对象计数减少**。</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">输入结果截图:</SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">![](http://p.blog.csdn.net/images/p_blog_csdn_net/ToCpp/EntryImages/20081002/未命名.jpg)</SPAN>

<SPAN></SPAN>

<SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes">由结果可以看出输出是又问题的，这是因为线程在执行过程中没有进行同步而引起的，后面再介绍解决这个问题的方法。</SPAN><SPAN style="FONT-SIZE: 10.5pt; mso-spacerun: yes"></SPAN>

</div>