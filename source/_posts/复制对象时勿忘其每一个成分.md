---
title: 复制对象时勿忘其每一个成分
id: 160
categories:
  - C++
date: 2009-04-19 21:56:00
tags:
---

    

前言：看了好久Effective，但是感觉好多都是看了就忘，现在再看一边，顺便把一些易忘的记录下来，争取每天一记。

概念：Copying函数，包括copy constructor;copy assignment operator，对于默认的编译器生成版，会将被拷贝的对象的所有成员变量都做一份拷贝。

如果你自己声明一个copying函数，编译器就会以一种奇怪的方式回应：当你的实现代码几乎必然出错时却不告诉你.(不知道是作者原话还是译者，感觉挺有意思的)

该条款有两个需要注意的地方：1复制所有local成员变量2调用所有base classes内的copying函数。

第一个地方还好，比较容易理解，下面主要讲讲第二个-&gt;

&nbsp;

&nbsp; 

<div class="dp-highlighter  nogutter">
<div class="bar">
<div class="tools">[<span style="color: #336699;">view plain</span>](file://C:/Users/QiuTao/Desktop/复制对象时勿忘其每一个成分 - whtuling2006的专栏 - CSDNBlog.mht#)[<span style="color: #336699;">copy to clipboard</span>](file://C:/Users/QiuTao/Desktop/复制对象时勿忘其每一个成分 - whtuling2006的专栏 - CSDNBlog.mht#)[<span style="color: #336699;">print</span>](file://C:/Users/QiuTao/Desktop/复制对象时勿忘其每一个成分 - whtuling2006的专栏 - CSDNBlog.mht#)[<span style="color: #336699;">?</span>](file://C:/Users/QiuTao/Desktop/复制对象时勿忘其每一个成分 - whtuling2006的专栏 - CSDNBlog.mht#)</div>
</div>

1.  <span><span class="keyword">void</span><span>&nbsp;logCall(</span><span class="keyword">const</span><span>&nbsp;std::string&amp;&nbsp;funcName);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">//&nbsp;make&nbsp;a&nbsp;log&nbsp;entry </span><span>&nbsp;&nbsp;</span></span>
2.  <span class="keyword">class</span><span>&nbsp;Customer&nbsp;{ &nbsp;&nbsp;</span>
3.  <span class="keyword">public</span><span>: &nbsp;&nbsp;</span>
4.  <span>&nbsp;&nbsp;... &nbsp;&nbsp;</span>
5.  <span>&nbsp;&nbsp;Customer(</span><span class="keyword">const</span><span>&nbsp;Customer&amp;&nbsp;rhs); &nbsp;&nbsp;</span>
6.  <span>&nbsp;&nbsp;Customer&amp;&nbsp;operator=(</span><span class="keyword">const</span><span>&nbsp;Customer&amp;&nbsp;rhs); &nbsp;&nbsp;</span>
7.  <span>&nbsp;&nbsp;... &nbsp;&nbsp;</span>
8.  <span class="keyword">private</span><span>: &nbsp;&nbsp;</span>
9.  <span>&nbsp;&nbsp;std::string&nbsp;name; &nbsp;&nbsp;</span>
10.  <span>}; &nbsp;&nbsp;</span>
11.  <span>&nbsp;&nbsp;</span>
12.  <span>Customer::Customer(</span><span class="keyword">const</span><span>&nbsp;Customer&amp;&nbsp;rhs) &nbsp;&nbsp;</span>
13.  <span>:&nbsp;name(rhs.name)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">//&nbsp;copy&nbsp;rhs's&nbsp;data </span><span>&nbsp;&nbsp;</span>
14.  <span>{ &nbsp;&nbsp;</span>
15.  <span>&nbsp;&nbsp;logCall(</span><span class="string">"Customer&nbsp;copy&nbsp;constructor"</span><span>); &nbsp;&nbsp;</span>
16.  <span>} &nbsp;&nbsp;</span>
17.  <span>&nbsp;&nbsp;</span>
18.  <span>Customer&amp;&nbsp;Customer::operator=(</span><span class="keyword">const</span><span>&nbsp;Customer&amp;&nbsp;rhs) &nbsp;&nbsp;</span>
19.  <span>{ &nbsp;&nbsp;</span>
20.  <span>&nbsp;&nbsp;logCall(</span><span class="string">"Customer&nbsp;copy&nbsp;assignment&nbsp;operator"</span><span>); &nbsp;&nbsp;</span>
21.  <span>&nbsp;&nbsp;name&nbsp;=&nbsp;rhs.name;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;</span>
22.  <span>&nbsp;&nbsp;</span><span class="keyword">return</span><span>&nbsp;*</span><span class="keyword">this</span><span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;</span>
23.  <span>} &nbsp;&nbsp;</span>
24.  <span>&nbsp;&nbsp;</span>
25.  <span class="keyword">class</span><span>&nbsp;Date&nbsp;{&nbsp;...&nbsp;};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">//&nbsp;for&nbsp;dates&nbsp;in&nbsp;time </span><span>&nbsp;&nbsp;</span>
26.  <span>&nbsp;&nbsp;</span>
27.  <span class="keyword">class</span><span>&nbsp;Customer&nbsp;{ &nbsp;&nbsp;</span>
28.  <span class="keyword">public</span><span>: &nbsp;&nbsp;</span>
29.  <span>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">//&nbsp;as&nbsp;before </span><span>&nbsp;&nbsp;</span>
30.  <span class="keyword">private</span><span>: &nbsp;&nbsp;</span>
31.  <span>&nbsp;&nbsp;std::string&nbsp;name; &nbsp;&nbsp;</span>
32.  <span>&nbsp;&nbsp;Date&nbsp;lastTransaction; &nbsp;&nbsp;</span>
33.  <span>}; &nbsp;&nbsp;</span>
34.  <span>&nbsp;&nbsp;</span>
35.  <span class="keyword">class</span><span>&nbsp;PriorityCustomer:&nbsp;</span><span class="keyword">public</span><span>&nbsp;Customer&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">//&nbsp;a&nbsp;derived&nbsp;class </span><span>&nbsp;&nbsp;</span>
36.  <span class="keyword">public</span><span>: &nbsp;&nbsp;</span>
37.  <span>&nbsp;&nbsp;&nbsp;... &nbsp;&nbsp;</span>
38.  <span>&nbsp;&nbsp;&nbsp;PriorityCustomer(</span><span class="keyword">const</span><span>&nbsp;PriorityCustomer&amp;&nbsp;rhs); &nbsp;&nbsp;</span>
39.  <span>&nbsp;&nbsp;&nbsp;PriorityCustomer&amp;&nbsp;operator=(</span><span class="keyword">const</span><span>&nbsp;PriorityCustomer&amp;&nbsp;rhs); &nbsp;&nbsp;</span>
40.  <span>&nbsp;&nbsp;&nbsp;... &nbsp;&nbsp;</span>
41.  <span class="keyword">private</span><span>: &nbsp;&nbsp;</span>
42.  <span>&nbsp;&nbsp;&nbsp;</span><span class="datatypes">**<span style="color: #2e8b57;">int</span>**</span><span>&nbsp;priority; &nbsp;&nbsp;</span>
43.  <span>}; &nbsp;&nbsp;</span>
44.  <span>&nbsp;&nbsp;</span>
45.  <span>PriorityCustomer::PriorityCustomer(</span><span class="keyword">const</span><span>&nbsp;PriorityCustomer&amp;&nbsp;rhs) &nbsp;&nbsp;</span>
46.  <span>:&nbsp;priority(rhs.priority) &nbsp;&nbsp;</span>
47.  <span>{ &nbsp;&nbsp;</span>
48.  <span>&nbsp;&nbsp;logCall(</span><span class="string">"PriorityCustomer&nbsp;copy&nbsp;constructor"</span><span>); &nbsp;&nbsp;</span>
49.  <span>} &nbsp;&nbsp;</span>
50.  <span>PriorityCustomer&amp;&nbsp;PriorityCustomer::operator=(</span><span class="keyword">const</span><span>&nbsp;PriorityCustomer&amp;&nbsp;rhs) &nbsp;&nbsp;</span>
51.  <span>{ &nbsp;&nbsp;</span>
52.  <span>&nbsp;&nbsp;logCall(</span><span class="string">"PriorityCustomer&nbsp;copy&nbsp;assignment&nbsp;operator"</span><span>); &nbsp;&nbsp;</span>
53.  <span>&nbsp;&nbsp;priority&nbsp;=&nbsp;rhs.priority; &nbsp;&nbsp;</span>
54.  <span>&nbsp;&nbsp;</span><span class="keyword">return</span><span>&nbsp;*</span><span class="keyword">this</span><span>; &nbsp;&nbsp;</span>
55.  <span>}&nbsp;&nbsp;</span></div>

PriorityCustomer类的copying函数好像复制了PriorityCustomer内的每一样东西，它复制了PriorityCustomer声明的成员变量，但是其基类Customer成员变量却没有被复制(其实应该是没有按照相应的参数复制，而是使用了这些变量的default构造函数)，这一点是尤其需要注意的，尤其是没有真正写过类似代码时很容易忽视这个问题，正确的写法是下面这样的：

&nbsp;

<div class="dp-highlighter  nogutter">
<div class="bar">
<div class="tools">[<span style="color: #336699;">view plain</span>](file://C:/Users/QiuTao/Desktop/复制对象时勿忘其每一个成分 - whtuling2006的专栏 - CSDNBlog.mht#)[<span style="color: #336699;">copy to clipboard</span>](file://C:/Users/QiuTao/Desktop/复制对象时勿忘其每一个成分 - whtuling2006的专栏 - CSDNBlog.mht#)[<span style="color: #336699;">print</span>](file://C:/Users/QiuTao/Desktop/复制对象时勿忘其每一个成分 - whtuling2006的专栏 - CSDNBlog.mht#)[<span style="color: #336699;">?</span>](file://C:/Users/QiuTao/Desktop/复制对象时勿忘其每一个成分 - whtuling2006的专栏 - CSDNBlog.mht#)</div>
</div>

1.  <span><span>PriorityCustomer::PriorityCustomer(</span><span class="keyword">const</span><span>&nbsp;PriorityCustomer&amp;&nbsp;rhs) &nbsp;&nbsp;</span></span>
2.  <span>:Customer(rhs),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">//&nbsp;invoke&nbsp;base&nbsp;class&nbsp;copy&nbsp;ctor </span><span>&nbsp;&nbsp;</span>
3.  <span>&nbsp;priority(rhs.priority) &nbsp;&nbsp;</span>
4.  <span>{ &nbsp;&nbsp;</span>
5.  <span>&nbsp;&nbsp;logCall(</span><span class="string">"PriorityCustomer&nbsp;copy&nbsp;constructor"</span><span>); &nbsp;&nbsp;</span>
6.  <span>} &nbsp;&nbsp;</span>
7.  <span>&nbsp;&nbsp;</span>
8.  <span>&nbsp;&nbsp;</span>
9.  <span>PriorityCustomer&amp;&nbsp;PriorityCustomer::operator=(</span><span class="keyword">const</span><span>&nbsp;PriorityCustomer&amp;&nbsp;rhs) &nbsp;&nbsp;</span>
10.  <span>{ &nbsp;&nbsp;</span>
11.  <span>&nbsp;&nbsp;logCall(</span><span class="string">"PriorityCustomer&nbsp;copy&nbsp;assignment&nbsp;operator"</span><span>); &nbsp;&nbsp;</span>
12.  <span>&nbsp;&nbsp;Customer::operator=(rhs);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">//&nbsp;assign&nbsp;base&nbsp;class&nbsp;parts </span><span>&nbsp;&nbsp;</span>
13.  <span>&nbsp;&nbsp;priority&nbsp;=&nbsp;rhs.priority; &nbsp;&nbsp;</span>
14.  <span>&nbsp;&nbsp;</span><span class="keyword">return</span><span>&nbsp;*</span><span class="keyword">this</span><span>; &nbsp;&nbsp;</span>
15.  <span>}&nbsp;&nbsp;</span></div>

具体内容见Items12。

</div>