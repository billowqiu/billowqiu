---
title: VS2005内存泄漏检测方法
id: 146
categories:
  - VC
date: 2009-07-06 00:55:00
tags:
---

    <div>

原文地址：&nbsp;[http://ufownl.blog.163.com/blog/static/1250122200861912757566/](http://ufownl.blog.163.com/blog/static/1250122200861912757566/)

非MFC程序可以用以下方法检测内存泄露：

&nbsp;

1.程序开始包含如下定义：

#define _CRTDBG_MAP_ALLOC
#include &lt;stdlib.h&gt;
#include &lt;crtdbg.h&gt;

&nbsp;

2.程序退出前添加下面的函数：

_CrtDumpMemoryLeaks();

&nbsp;

Debug版本程序运行结束后如有内存泄漏，输出窗口中会显示类似信息：
Detected memory leaks!
Dumping objects -&gt;
e:/microsoft visual studio 8/vc/include/crtdbg.h(1150) : {48} normal block at 0x00382F50, 12 bytes long.
&nbsp;Data: &lt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt; 01 00 00 00 02 00 00 00 03 00 00 00 
Object dump complete.

&nbsp;

&nbsp;

MFC程序内存泄漏检测方法：

&nbsp;

1.在 CMyApp 中添加如下三个 CMemoryState 类的成员变量：

#ifdef _DEBUG
protected:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CMemoryState m_msOld, m_msNew, m_msDiff;
#endif&nbsp; // _DEBUG

&nbsp;

2.在 CMyApp::InitInstance() 中添加如下代码：

#ifdef _DEBUG
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_msOld.Checkpoint();
#endif&nbsp; // _DEBUG

&nbsp;

3.在 CMyApp::ExitInstance() 中添加如下代码：

#ifdef _DEBUG
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_msNew.Checkpoint();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (m_msDiff.Difference(m_msOld, m_msNew))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; afxDump&lt;&lt;"/nMemory Leaked :/n";
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_msDiff.DumpStatistics();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; afxDump&lt;&lt;"Dump Complete !/n/n";
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
#endif&nbsp; // _DEBUG

&nbsp;

Debug版本程序运行结束后如有内存泄漏，输出窗口中会显示类似信息：

Memory Leaked :
0 bytes in 0 Free Blocks.
8 bytes in 1 Normal Blocks.
0 bytes in 0 CRT Blocks.
0 bytes in 0 Ignore Blocks.
0 bytes in 0 Client Blocks.
Largest number used: 8825 bytes.
Total allocations: 47506 bytes.
Dump Complete !

Detected memory leaks!
Dumping objects -&gt;
g:/programs/chat/chatdlg.cpp(120) : {118} normal block at 0x00D98150, 8 bytes long.
&nbsp;Data: &lt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt; A8 7F D9 00 01 00 00 00 
Object dump complete.

</div>
</div>